<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>KillPay开发（AccessibleService） | README.MD</title>
  <meta name="author" content="Dio_V">
  
  <meta name="description" content="通过无障碍设置完成自动停止后台进程的实现">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="KillPay开发（AccessibleService）"/>
  <meta property="og:site_name" content="README.MD"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?8190074";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">README.MD</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> KillPay开发（AccessibleService）</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> 通过无障碍设置完成自动停止后台进程的实现
		 </div> <!-- alert -->
	  		

	  <p>之前用<a href="http://coolapk.com/apk/com.oasisfeng.greenify" target="_blank" rel="external">绿色守护</a>的时候有一个功能，强制关闭后台进程。如果没有root的话，其实就时调用应用的详情页，然后强制停止。<br>刷完机以后并不打算安装支付宝（愈来愈流氓了），没几天就发现已经少不了这玩意儿了..</p>
<a id="more"></a>
<p>正好这段时间，有好多人自己开发抢红包的小应用，用到的就是AccessibleService。正好可以用来实现我的功能需求。先来分析一下业务，其实非常的简单：</p>
<ol>
<li>将AccessibleService开启</li>
<li>如果后台有进程在运行，跳转到应用详情界面</li>
<li>通过AccessibleService将进程停止</li>
</ol>
<p>用到的都是SDK中提供的API，如果有不明白的可以查阅文档，很详细。</p>
<h1 id="界面跳转"><a href="#界面跳转" class="headerlink" title="界面跳转"></a>界面跳转</h1><p>整个应用涉及到两个跳转，一个是”无障碍”（或者叫“辅助”）界面的跳转，另一个是指定应用的应用详情界面的跳转。<br>先来实现跳转无障碍界面：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent accessibleIntent = <span class="keyword">new</span> Intent(Settings.ACTION_ACCESSIBILITY_SETTINGS);</span><br><span class="line">startActivity(accessibleIntent);</span><br></pre></td></tr></table></figure></p>
<p>接着是跳转到应用详情界面<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Intent i = <span class="keyword">new</span> Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);</span><br><span class="line">i.setData(Uri.parse(<span class="string">"package:"</span> + packageName));</span><br><span class="line">startActivity(i);</span><br></pre></td></tr></table></figure></p>
<p>这里需要通过<code>setData(Uri data)</code>方法传入一个Uri，确定跳转到那个应用的详情界面。</p>
<h1 id="自动关闭"><a href="#自动关闭" class="headerlink" title="自动关闭"></a>自动关闭</h1><p>跳转到详情界面以后就是实现功能的关键步骤，通过AccessibleService自动关闭后台进程。首先来看一下AccessibleService的官方描述：</p>
<blockquote>
<p>An accessibility service is an application that provides user interface enhancements to assist users with disabilities, or who may temporarily be unable to fully interact with a device. For example, users who are driving, taking care of a young child or attending a very loud party might need additional or alternative interface feedback.</p>
</blockquote>
<p>也就是说AccessibleService是为不方便使用手机的人准备的，那我们正好不方便去点击”强制停止”-&gt;“确认”按钮（懒），所以完全可以借助这个API来实现自动的点击。</p>
<p>下面正式来使用AccessibleService：</p>
<ol>
<li><p><strong>在清单文件中注册</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">service</span></span><br><span class="line">    <span class="attribute">android:name</span>=<span class="value">".util.ForcecloseAccessibilityService"</span></span><br><span class="line">    <span class="attribute">android:label</span>=<span class="value">"@string/accessibility_service_label"</span></span><br><span class="line">    <span class="attribute">android:permission</span>=<span class="value">"android.permission.BIND_ACCESSIBILITY_SERVICE"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.accessibilityservice.AccessibilityService"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">meta-data</span></span><br><span class="line">        <span class="attribute">android:name</span>=<span class="value">"android.accessibilityservice"</span></span><br><span class="line">        <span class="attribute">android:resource</span>=<span class="value">"@xml/accessibility_service_config"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>想要使用AccessibleService必须要获取到<code>android.permission.BIND_ACCESSIBILITY_SERVICE</code>这个权限，<code>intent-filter</code>中的内容按照官方文档来填写就行了。至于<code>name</code>和<code>label</code>标签就不解释了。而<code>meta-data</code>中配置了服务的一些属性，我们在下一步完成</p>
</li>
<li><p><strong>配置AccessibleService</strong></p>
<p>在xml文件夹下创建一个.xml文件，文件名与<code>meta-data</code>中的<code>resource</code>保持一致就可以了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">accessibility-service</span></span><br><span class="line">    <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">android:accessibilityEventTypes</span>=<span class="value">"typeAllMask"</span></span><br><span class="line">    <span class="attribute">android:accessibilityFeedbackType</span>=<span class="value">"feedbackAllMask"</span></span><br><span class="line">    <span class="attribute">android:accessibilityFlags</span>=<span class="value">"flagDefault"</span></span><br><span class="line">    <span class="attribute">android:canRetrieveWindowContent</span>=<span class="value">"true"</span></span><br><span class="line">    <span class="attribute">android:description</span>=<span class="value">"@string/app_name"</span></span><br><span class="line">    <span class="attribute">android:notificationTimeout</span>=<span class="value">"100"</span></span><br><span class="line">    <span class="attribute">android:packageNames</span>=<span class="value">"com.android.settings"</span></span><br><span class="line">    /&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>android:accessibilityEventTypes</code>：接受事件的类型</li>
<li><code>android:accessibilityFeedbackType</code>：对事件反馈的类型</li>
<li><code>android:canRetrieveWindowContent</code>：服务能否获取页面内容</li>
<li><code>android:packageNames</code>：想要监听那个包下的内容。注意，当我们使用AccessibleService来获取页面上的内容时，他是遍历所有的控件。如果不这是指定的报名的话，开启服务后会消耗大量的资源，所以建议如果只需要监听特定界面的话直接指定包名。</li>
</ul>
</li>
<li><p><strong>创建AccessibleService的子类</strong></p>
<p>创建AccessibleService的子类，需要实现<code>onAccessibilityEvent(AccessibilityEvent event)</code>和<code>`onInterrupt()</code>方法。其中我们对于自动关闭的业务逻辑就写在<code>onAccessibilityEvent(AccessibilityEvent event)</code>方法中，当服务接收到AccessibilityEvent时会回调这个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findAndPerformAction</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 查找当前窗口中包含文字的按钮</span></span><br><span class="line">    <span class="keyword">if</span> (getRootInActiveWindow() == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//通过文字找到当前的节点</span></span><br><span class="line">    List&lt;AccessibilityNodeInfo&gt; nodes = getRootInActiveWindow().findAccessibilityNodeInfosByText(text);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodes.size(); i++) &#123;</span><br><span class="line">        AccessibilityNodeInfo node = nodes.get(i);</span><br><span class="line">        <span class="comment">// 执行按钮点击行为</span></span><br><span class="line">        <span class="keyword">if</span> (node.getClassName().equals(<span class="string">"android.widget.Button"</span>) &amp;&amp; node.isEnabled()) &#123;</span><br><span class="line">            node.performAction(AccessibilityNodeInfo.ACTION_CLICK);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在自定义的AccessibleService中，主要的方法就是自定义的<code>findAndPerformAction()</code>方法。<br>窗口内所有的控件及相关的内容都被封装在了<code>AccessibilityNodeInfo</code>对象中，根布局的<code>AccessibilityNodeInfo</code>下每一个控件仍然是一个个<code>AccessibilityNodeInfo</code>对象（与<code>jsonObject</code>的结构相似）。</p>
<ul>
<li>首先是通过<code>getRootInActiveWindow()</code>获取根布局，该方法在API 16才添加。API 16之前的可以使用<code>getResources()</code>方法；</li>
<li>之后调用<code>findAccessibilityNodeInfoByText(String text)</code>方法遍历所有的子控件，根据指定的字符串找到控件的集合；</li>
<li>因为我们已经知道在应用详情的界面，通常一个指定的字符串只会出现在一个控件上。所以直接获取集合的第一个元素，调用<code>performAction(int action)</code>，传入<code>AccessibilityNodeInfo.ACTION_CLICK</code>，完成点击事件。</li>
</ul>
<p>之后，在<code>onAccessibilityEvent(AccessibilityEvent event)</code>方法中，我们只需要依次调用<code>findAndPerformAction(&quot;强行停止&quot;)</code>和<code>findAndPerformAction(&quot;确定&quot;)</code>就可以实现自动停止进程的功能了。</p>
</li>
</ol>
<h1 id="一些重构"><a href="#一些重构" class="headerlink" title="一些重构"></a>一些重构</h1><p>写完之后发现在<code>MainActivity.java</code>中加入了不少 <em>迷之嵌套</em> ，就简单的重构了一下。<br>其实在实际开发中对于业务逻辑不注意的话很容易就添加很多嵌套，增大了代码阅读的难度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isInstall) &#123;</span><br><span class="line">    Snackbar.make(view, <span class="string">"应用未安装"</span>, Snackbar.LENGTH_SHORT).show();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!isRunning) &#123;</span><br><span class="line">    Snackbar.make(view, <span class="string">"后台未运行,无需关闭"</span>, Snackbar.LENGTH_SHORT).show();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (AppHelper.isServiceRunning(MainActivity.<span class="keyword">this</span>, getPackageName())) &#123;</span><br><span class="line">    <span class="comment">// 根据包名跳转系统自带的应用程序信息界面,并自动关闭</span></span><br><span class="line">    jumpDetailInfo(packageName);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Snackbar.make(view, <span class="string">"服务未开启,请打开"</span>, Snackbar.LENGTH_SHORT).setAction(<span class="string">"打开"</span>,</span><br><span class="line">            <span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                    openAccessibleSetting();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是重构后的代码，感觉仍然写的不够优雅…</p>
<p>至此，这个应用的主要功能就都完成了。因为都是直接调用SDK中的API，所以并没有什么难点。其他的一些查询应用安装及后台是否运行的方法也很简单，就不一一介绍了。有兴趣的可以查看我的仓库 <a href="https://github.com/diov/KillAPay" target="_blank" rel="external">diov/KillAPay</a></p>
<h3 id="一些题外话"><a href="#一些题外话" class="headerlink" title="一些题外话"></a>一些题外话</h3><p>十月份时候百度全家桶爆出的漏洞（后台），和最近了解到的支付宝各种强制开启“生活圈”和后台下载小视频，以及支付宝iOS端的后台播放无声音乐（多老的招数了）。似乎BAT里面反倒是山寨帝国Tencent显得最良心了。<br>不可否认BAT在国内互联网行业中的技术领军地位，也很佩服淘宝这样的应用要应对500多个业务还能很好实现（虽然很丑陋）的强大。但是真的想不明白这样完全不在乎用户感受的设计是出于什么样的一种考虑。</p>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2016/02/12/[T]Splash_Screens-the Right_Way/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> 上一页</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2016/01/17/Analisis_of_Touchevent_in_Android/" type="button" class="btn btn-default ">下一页<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
    <h2 class="title">留言</h2>

    
    <div class="ds-thread" data-thread-key="2016/01/28/KillPay_Dev_Experience/" data-title="KillPay开发（AccessibleService）"
         data-url="http://diov.github.io/2016/01/28/KillPay_Dev_Experience/"></div>
    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2016-01-28 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Android/">Android<span>7</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/个人项目/">个人项目<span>1</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#界面跳转"><span class="toc-article-text">界面跳转</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#自动关闭"><span class="toc-article-text">自动关闭</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#一些重构"><span class="toc-article-text">一些重构</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#一些题外话"><span class="toc-article-text">一些题外话</span></a></li></ol></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->

<script type="text/javascript">
  var duoshuoQuery = { short_name: 'diov87' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2016 Dio_V
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
