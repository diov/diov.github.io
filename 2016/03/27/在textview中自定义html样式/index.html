<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>在TextView中自定义HTML样式</title>
  <meta name="description" content="通过对Html.fromHtml的源码分析，自定义Html标签的样式">
  <meta name="author" content="Dio_V"/>
  <meta name="generator" content="Hugo 0.19" />
  <link href='https://diov.github.io//img/favicon.ico' rel='icon' type='image/x-icon'/>

  <link rel="alternate" href="https://diov.github.io/index.xml" type="application/rss+xml" title="Meow">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://diov.github.io//css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://diov.github.io//css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://diov.github.io//css/pygment_highlights.css" />
  <link rel="stylesheet" href="https://diov.github.io/css/highlight.min.css">
  
  
  <meta property="og:title" content="在TextView中自定义HTML样式" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/2016/03/27/%E5%9C%A8textview%E4%B8%AD%E8%87%AA%E5%AE%9A%E4%B9%89html%E6%A0%B7%E5%BC%8F" />
  <meta property="og:image" content="/img/avatar-icon.png" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://diov.github.io/">Meow</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
          <a title="Blog" href="../../../../">Blog</a>
  	      </li>
  	    
      
        
          <li>
          <a title="About" href="../../../../page/about/">About</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
          <a title="Meow" href="https://diov.github.io/">
              <img class="avatar-img" src="https://diov.github.io//img/avatar-icon.png" alt="Meow" />
          </a>
      
	  </div>
	</div>

  </div>
</nav>


    <div role="main" class="container main-content">

      



  

  <header class="header-section ">
  
  <div class="intro-header no-img">
      <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>在TextView中自定义HTML样式</h1>
      
      
      
      <span class="post-meta">Posted on March 27, 2016</span>
      
        </div>
      </div>
    </div>
  </div>
  </div>
  </header>

	  
      
        <div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
          

<p>通常，当我们需要在TextView中显示服务器端返回的Html内容时，就会用到<code>Html.fromHtml(String source)</code>这个方法。Google在源码中默认的为我们提供了对一些Html标签的支持。<br />
但是如果我们想要对已有的标签进行自定义展示，或者是有些标签还没有得到支持，那应该怎么做呢？</p>

<!-- more -->

<hr />

<h1 id="html源码分析">Html源码分析</h1>

<p>我们知道，使用<code>Html.fromHtml(String source)</code>这个方法时，我们需要将带有Html标签的文本作为参数传递过来。那么在Html这个类中必然会有对不同的标签进行判断，并添加样式的方法。通过查找，主要是由两个方法来完成的</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleStartTag</span><span class="o">(</span><span class="n">String</span> <span class="n">tag</span><span class="o">,</span> <span class="n">Attributes</span> <span class="n">attributes</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;br&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// We don&#39;t need to handle this. TagSoup will ensure that there&#39;s a &lt;/br&gt; for each &lt;br&gt;</span>
        <span class="c1">// so we can safely emite the linebreaks when we handle the close tag.</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;p&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">handleP</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;div&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">handleP</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;strong&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Bold</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Bold</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;em&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Italic</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;cite&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Italic</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;dfn&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Italic</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;i&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Italic</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;big&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Big</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;small&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Small</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;font&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">startFont</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">attributes</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;blockquote&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">handleP</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">);</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Blockquote</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;tt&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Monospace</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">startA</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">attributes</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;u&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Underline</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;sup&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Super</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;sub&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Sub</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
               <span class="n">Character</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">==</span> <span class="sc">&#39;h&#39;</span> <span class="o">&amp;&amp;</span>
               <span class="n">tag</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="sc">&#39;1&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">tag</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="sc">&#39;6&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handleP</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">);</span>
        <span class="n">start</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">Header</span><span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">-</span> <span class="sc">&#39;1&#39;</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;img&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">startImg</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">attributes</span><span class="o">,</span> <span class="n">mImageGetter</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mTagHandler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mTagHandler</span><span class="o">.</span><span class="na">handleTag</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">tag</span><span class="o">,</span> <span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">mReader</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleEndTag</span><span class="o">(</span><span class="n">String</span> <span class="n">tag</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;br&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">handleBr</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;p&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">handleP</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;div&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">handleP</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;strong&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">end</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">Bold</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">StyleSpan</span><span class="o">(</span><span class="n">Typeface</span><span class="o">.</span><span class="na">BOLD</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">end</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">Bold</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">StyleSpan</span><span class="o">(</span><span class="n">Typeface</span><span class="o">.</span><span class="na">BOLD</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;em&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">end</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">Italic</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">StyleSpan</span><span class="o">(</span><span class="n">Typeface</span><span class="o">.</span><span class="na">ITALIC</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;cite&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">end</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">Italic</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">StyleSpan</span><span class="o">(</span><span class="n">Typeface</span><span class="o">.</span><span class="na">ITALIC</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;dfn&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">end</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">Italic</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">StyleSpan</span><span class="o">(</span><span class="n">Typeface</span><span class="o">.</span><span class="na">ITALIC</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;i&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">end</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">Italic</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">StyleSpan</span><span class="o">(</span><span class="n">Typeface</span><span class="o">.</span><span class="na">ITALIC</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;big&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">end</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">Big</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">RelativeSizeSpan</span><span class="o">(</span><span class="mf">1.25f</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;small&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">end</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">Small</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">RelativeSizeSpan</span><span class="o">(</span><span class="mf">0.8f</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;font&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">endFont</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;blockquote&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">handleP</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">);</span>
        <span class="n">end</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">Blockquote</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">QuoteSpan</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;tt&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">end</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">Monospace</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">TypefaceSpan</span><span class="o">(</span><span class="s">&quot;monospace&quot;</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">endA</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;u&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">end</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">Underline</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">UnderlineSpan</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;sup&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">end</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">Super</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">SuperscriptSpan</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;sub&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">end</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">Sub</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="k">new</span> <span class="n">SubscriptSpan</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
            <span class="n">Character</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span> <span class="o">==</span> <span class="sc">&#39;h&#39;</span> <span class="o">&amp;&amp;</span>
            <span class="n">tag</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="sc">&#39;1&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">tag</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="sc">&#39;6&#39;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">handleP</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">);</span>
        <span class="n">endHeader</span><span class="o">(</span><span class="n">mSpannableStringBuilder</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">mTagHandler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mTagHandler</span><span class="o">.</span><span class="na">handleTag</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">tag</span><span class="o">,</span> <span class="n">mSpannableStringBuilder</span><span class="o">,</span> <span class="n">mReader</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>因为Html标签总是成对出现，所以有<code>handleStartTag</code>和<code>HandleEndTag</code>两个方法。<br />
其实在这两个方法中，都是对一些标签进行了判断，在调用<code>start(SpannableStringBuilder text, Class kind, Object repl)</code>和<code>end(SpannableStringBuilder text, Class kind, Object repl)</code>这两个方法。</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">SpannableStringBuilder</span> <span class="n">text</span><span class="o">,</span> <span class="n">Object</span> <span class="n">mark</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
    <span class="n">text</span><span class="o">.</span><span class="na">setSpan</span><span class="o">(</span><span class="n">mark</span><span class="o">,</span> <span class="n">len</span><span class="o">,</span> <span class="n">len</span><span class="o">,</span> <span class="n">Spannable</span><span class="o">.</span><span class="na">SPAN_MARK_MARK</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">end</span><span class="o">(</span><span class="n">SpannableStringBuilder</span> <span class="n">text</span><span class="o">,</span> <span class="n">Class</span> <span class="n">kind</span><span class="o">,</span>
                        <span class="n">Object</span> <span class="n">repl</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
    <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">getLast</span><span class="o">(</span><span class="n">text</span><span class="o">,</span> <span class="n">kind</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">where</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="na">getSpanStart</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>

    <span class="n">text</span><span class="o">.</span><span class="na">removeSpan</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">where</span> <span class="o">!=</span> <span class="n">len</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">text</span><span class="o">.</span><span class="na">setSpan</span><span class="o">(</span><span class="n">repl</span><span class="o">,</span> <span class="n">where</span><span class="o">,</span> <span class="n">len</span><span class="o">,</span> <span class="n">Spannable</span><span class="o">.</span><span class="na">SPAN_EXCLUSIVE_EXCLUSIVE</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>在这两个方法中，最核心的代码就是<code>SpannableStringBuilder.setSpan(Object what, int start, int end, int flags)</code>。</p>

<blockquote>
<p>Mark the specified range of text with the specified object. The flags determine how the span will behave when text is inserted at the start or end of the span&rsquo;s range.</p>
</blockquote>

<p>通过查阅文档，我们可以知道这个方法是将text中指定的区域添加上样式，flag参数决定在指定范围前后插入文本时是否采用同样的样式</p>

<h1 id="解决问题">解决问题</h1>

<p>现在我们知道了<code>Html.fromHtml</code>是如何来实现对Html标签的解析并且添加上样式。那么如何来解决我们最开始提出的问题呢？</p>

<ul>
<li>例： 搜索指定字段，服务器返回的搜索结果中，将字段添加<em>标签返回。此时使用<code>Html.from</code>默认的样式是斜体，而我们需要给字段添加背景为黄色的高亮。</li>
</ul>

<blockquote>
<p>&lsquo;em&rsquo; 标签告诉浏览器把其中的文本表示为强调的内容。对于所有浏览器来说，这意味着要把这段文字用斜体来显示。<br />
除强调之外，当引入新的术语或在引用特定类型的术语或概念时作为固定样式的时候，也可以考虑使用 &lsquo;em&rsquo; 标签。</p>
</blockquote>

<h2 id="替换样式">替换样式</h2>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">Spannable</span> <span class="n">source</span> <span class="o">=</span> <span class="o">(</span><span class="n">Spannable</span><span class="o">)</span> <span class="n">Html</span><span class="o">.</span><span class="na">fromHtml</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>
  <span class="kd">final</span> <span class="n">StyleSpan</span><span class="o">[]</span> <span class="n">styleSpans</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="na">getSpans</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">source</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span> <span class="n">StyleSpan</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">styleSpans</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">styleSpans</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">StyleSpan</span> <span class="n">styleSpan</span> <span class="o">:</span> <span class="n">styleSpans</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">Typeface</span><span class="o">.</span><span class="na">ITALIC</span> <span class="o">==</span> <span class="n">styleSpan</span><span class="o">.</span><span class="na">getStyle</span><span class="o">())</span> <span class="o">{</span>
              <span class="n">source</span><span class="o">.</span><span class="na">setSpan</span><span class="o">(</span><span class="k">new</span> <span class="n">BackgroundColorSpan</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">YELLOW</span><span class="o">),</span> <span class="n">source</span><span class="o">.</span><span class="na">getSpanStart</span><span class="o">(</span><span class="n">styleSpan</span><span class="o">),</span>
                      <span class="n">source</span><span class="o">.</span><span class="na">getSpanEnd</span><span class="o">(</span><span class="n">styleSpan</span><span class="o">),</span> <span class="n">Spannable</span><span class="o">.</span><span class="na">SPAN_EXCLUSIVE_EXCLUSIVE</span><span class="o">);</span>
              <span class="n">source</span><span class="o">.</span><span class="na">removeSpan</span><span class="o">(</span><span class="n">styleSpan</span><span class="o">);</span>
          <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div>

<p>通过<code>setSpan</code>和<code>removeSpan</code>，我们将原有的<code>StyleSpan(Typeface.ITALIC)</code>移除，转而替换为<code>BackgroundColorSpan</code>。</p>

<h2 id="自定义taghandler">自定义TagHandler</h2>

<p>使用重载的<code>Html.fromHtml(String source, ImageGetter imageGetter, TagHandler tagHandler)</code>方法</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTagHandler</span> <span class="kd">implements</span> <span class="n">TagHandler</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">sIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>  
    <span class="kd">private</span>  <span class="kt">int</span> <span class="n">eIndex</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Context</span> <span class="n">mContext</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MxgsaTagHandler</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">){</span>
        <span class="n">mContext</span><span class="o">=</span><span class="n">context</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleTag</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">opening</span><span class="o">,</span> <span class="n">String</span> <span class="n">tag</span><span class="o">,</span> <span class="n">Editable</span> <span class="n">output</span><span class="o">,</span> <span class="n">XMLReader</span> <span class="n">xmlReader</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tag</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;eem&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">opening</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sIndex</span><span class="o">=</span><span class="n">output</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
            <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                <span class="n">eIndex</span><span class="o">=</span><span class="n">output</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
                <span class="n">output</span><span class="o">.</span><span class="na">setSpan</span><span class="o">(</span><span class="k">new</span> <span class="n">BackgroundColorSpan</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">YELLOW</span><span class="o">),</span> <span class="n">source</span><span class="o">.</span><span class="na">getSpanStart</span><span class="o">(</span><span class="n">styleSpan</span><span class="o">),</span>
                        <span class="n">source</span><span class="o">.</span><span class="na">getSpanEnd</span><span class="o">(</span><span class="n">styleSpan</span><span class="o">),</span> <span class="n">Spannable</span><span class="o">.</span><span class="na">SPAN_EXCLUSIVE_EXCLUSIVE</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>使用自定义的TagHandler时需要注意的一点是，因为<code>Html.fromHtml</code>会先调用默认的逻辑来添加样式，此时是不会调用到我们自己实现的TagHandler中的逻辑的。这时候我们只能先将初始文本通过正则表达式进行替换。<br />
所以当<code>Html</code>类中没有进行处理的Html标签，再考虑使用自定义TagHandler会是一个更好的选择。</p>

      </article>

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="https://diov.github.io/2016/03/20/%E4%BB%8Eaidl%E6%B5%85%E6%9E%90binder%E6%9C%BA%E5%88%B6" data-toggle="tooltip" data-placement="top" title="从AIDL浅析Binder机制">&larr; Previous Post</a>
        </li>
        
        
        <li class="next">
          <a href="https://diov.github.io/2016/06/12/%E5%9F%BA%E4%BA%8E-sdk-24-%E7%9A%84-android-background-drawable-%E8%A7%A3%E6%9E%90" data-toggle="tooltip" data-placement="top" title="基于 SDK-24 的 Android Background-Drawable 解析">Next Post &rarr;</a>
        </li>
        
      </ul>

      
      <div class="disqus-comments">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'diovgithubio';
    var disqus_identifier = 'https:\/\/diov.github.io\/2016\/03\/27\/%E5%9C%A8textview%E4%B8%AD%E8%87%AA%E5%AE%9A%E4%B9%89html%E6%A0%B7%E5%BC%8F';
    var disqus_title = '在TextView中自定义HTML样式';
    var disqus_url = 'https:\/\/diov.github.io\/2016\/03\/27\/%E5%9C%A8textview%E4%B8%AD%E8%87%AA%E5%AE%9A%E4%B9%89html%E6%A0%B7%E5%BC%8F';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      

    </div>
  </div>
</div>

      

    </div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/diov" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
		      
          <li>
            <a href="mailto:diov87@outlook.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
	    	  
          
          

    		  <li>
      			<a href="https://diov.github.io/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="credits copyright text-muted">
    	  Dio_V
    	  &nbsp;&bull;&nbsp;
    	  2017
    		  
    	  
    	  &nbsp;&bull;&nbsp;
    	  <a href="https://diov.github.io/">Meow</a>
    	  
  	    </p>
  	    
    	<p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.19</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a> adapted to <a href="https://github.com/1138-4EB/beautifulhugo">Beautiful Hugo</a>
          
    	</p>
      </div>
    </div>
  </div>
</footer>

<script src="https://diov.github.io//js/jquery-1.11.2.min.js"></script>
<script src="https://diov.github.io//js/bootstrap.min.js"></script>
<script src="https://diov.github.io//js/main.js"></script>
<script src="https://diov.github.io/js/highlight.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>




  </body>
</html>
