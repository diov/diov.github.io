<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>åˆ©ç”¨ StrictMode å’Œ MAT è§£å†³å†…å­˜æ³„æ¼</title>
  <meta name="description" content="é€šè¿‡ MAT è§£å†³å†…å­˜æ³„æ¼çš„å®ä¾‹">
  <meta name="author" content="Dio_V"/>
  <meta name="generator" content="Hugo 0.27.1" />
  <link href='https://diov.github.io//img/favicon.ico' rel='icon' type='image/x-icon'/>

  <link rel="alternate" href="https://diov.github.io/index.xml" type="application/rss+xml" title="Meow">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://diov.github.io//css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://diov.github.io//css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://diov.github.io//css/pygment_highlights.css" />
  <link rel="stylesheet" href="https://diov.github.io/css/highlight.min.css">
  
  
  <meta property="og:title" content="åˆ©ç”¨ StrictMode å’Œ MAT è§£å†³å†…å­˜æ³„æ¼" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/2017/03/10/%E5%88%A9%E7%94%A8-strictmode-%E5%92%8C-mat-%E8%A7%A3%E5%86%B3%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/" />
  <meta property="og:image" content="/img/avatar-icon.png" />
  
</head>


  <body>

    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://diov.github.io/">Meow</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
          <a title="Blog" href="../../../../">Blog</a>
  	      </li>
  	    
      
        
          <li>
          <a title="About" href="../../../../page/about/">About</a>
  	      </li>
  	    
      
      </ul>
    </div>

	<div class="avatar-container">
	  <div class="avatar-img-border">
      
          <a title="Meow" href="https://diov.github.io/">
              <img class="avatar-img" src="https://diov.github.io//img/avatar-icon.png" alt="Meow" />
          </a>
      
	  </div>
	</div>

  </div>
</nav>


    <div role="main" class="container main-content">

      



  

  <header class="header-section ">
  
  <div class="intro-header no-img">
      <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>åˆ©ç”¨ StrictMode å’Œ MAT è§£å†³å†…å­˜æ³„æ¼</h1>
      
      
      
      <span class="post-meta">Posted on March 10, 2017</span>
      
        </div>
      </div>
    </div>
  </div>
  </div>
  </header>

	  
      
        <div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
          

<p>å‰ä¸€é˜µå­æ­£å¥½ç¢°åˆ°äº† App é‡Œå‡ºç°å†…å­˜æ³„æ¼ï¼Œè®°å½•ä¸€ä¸‹å®Œæ•´çš„æµç¨‹ã€‚</p>

<h2 id="èµ·å› ">èµ·å› </h2>

<p>åœ¨è¿è¡Œæ—¶æ£€æµ‹ App çš„å†…å­˜æ³„æ¼æœ‰å¤šç§æ–¹å¼ï¼šæ¯”å¦‚æ‰‹åŠ¨çš„åœ¨ Android Studio ä¸­è°ƒç”¨ GC,ç„¶åè§‚å¯Ÿå†…å­˜æŠ–åŠ¨çš„æƒ…å†µï¼›æ¯”å¦‚åœ¨ App ä¸­åŠ å…¥ leakcanary è¿™æ ·çš„ libï¼Œå½“å‘ç”Ÿå†…å­˜æ³„æ¼æ—¶ç›´æ¥è¾“å‡º Heap Dumpã€‚ä¸è¿‡æˆ‘ä¸€ç›´ä¸å¸Œæœ›åœ¨ App ä¸­å¼•å…¥è¿‡å¤šçš„ libï¼Œæ‰€ä»¥æˆ‘æ˜¯é€šè¿‡ StrictMode æ¥ç›‘æµ‹ App æœ‰æ²¡æœ‰å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚</p>

<blockquote>
<p>StrictMode æ˜¯ Android 2.3 ä¹‹ååŠ å…¥çš„ä¸€ä¸ªç±»ï¼Œç”¨ä»¥æ£€æµ‹ç¨‹åºä¸­æ˜¯å¦æœ‰è¿ä¾‹æƒ…å†µå‘ç”Ÿçš„å¼€å‘è€…å·¥å…·ã€‚</p>
</blockquote>

<p>åœ¨è‡ªå®šä¹‰çš„ Application ä¸­çš„ <code>onCreate()</code> æ–¹æ³•ä¸­åˆå§‹åŒ– StrictMode å°±å¯ä»¥äº†</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">BuildConfig</span><span class="o">.</span><span class="na">DEBUG</span><span class="o">)</span> <span class="o">{</span>
        <span class="err"></span><span class="c1">// è®¾ç½®çº¿ç¨‹ç­–ç•¥å’Œ VMç­–ç•¥</span>
        <span class="n">StrictMode</span><span class="o">.</span><span class="na">setThreadPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">StrictMode</span>
                                        <span class="o">.</span><span class="na">ThreadPolicy</span>
                                        <span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
                                        <span class="o">.</span><span class="na">detectAll</span><span class="o">()</span>
                                        <span class="o">.</span><span class="na">penaltyLog</span><span class="o">()</span>
                                        <span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="n">StrictMode</span><span class="o">.</span><span class="na">setVmPolicy</span><span class="o">(</span><span class="k">new</span> <span class="n">StrictMode</span>
                                    <span class="o">.</span><span class="na">VmPolicy</span><span class="o">.</span>
                                    <span class="n">Builder</span><span class="o">().</span>
                                    <span class="n">detectAll</span><span class="o">().</span>
                                    <span class="n">penaltyLog</span><span class="o">().</span>
                                    <span class="n">build</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>ä¹‹åå¦‚æœæœ‰å†…å­˜æ³„æ¼ã€æœªå…³é—­ closable å¯¹è±¡æˆ–åœ¨ä¸»çº¿ç¨‹ä¸­ç›‘æµ‹åˆ°è€—æ—¶æ“ä½œæ—¶ï¼ŒStrictMode å°±ä¼šé€šè¿‡ log è¾“å‡ºæ¥æé†’æˆ‘ä»¬ã€‚</p>

<h2 id="åˆ©ç”¨-android-studio-è·å–-java-heap">åˆ©ç”¨ Android Studio è·å– Java Heap</h2>

<p><img src="http://o9xs75p7d.bkt.clouddn.com/2017-03-10-084831.jpg" alt="å‘ç”Ÿå†…å­˜æ³„æ¼çš„ log" /></p>

<p>ä¹‹åï¼Œå½“æŸæ¬¡å‘ç”Ÿå†…å­˜æ³„æ¼æ—¶ï¼ŒStrictMode å°±é€šè¿‡ log æç¤ºæˆ‘ä»¬ã€‚æ­¤å¤„æ˜¯æˆ‘çš„ App æ‰€é‡åˆ°çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨å¤šä¸ª Activity å®ä¾‹ï¼Œå¹¶ä¸”æ— æ³•é‡Šæ”¾ã€‚</p>

<p><img src="http://o9xs75p7d.bkt.clouddn.com/2017-03-10-085229.jpg" alt="è·å– Java Heap" /></p>

<p>æ­¤æ—¶å¯ä»¥é€šè¿‡ Android Studio è‡ªå¸¦çš„ Monitor æ¥è·å–æ­¤æ—¶åº”ç”¨çš„å †ä¿¡æ¯ã€‚</p>

<ol>
<li>ç‚¹å‡»<code>Initate GC</code>æŒ‰é’®ï¼Œå¼ºåˆ¶ GC</li>
<li>ç‚¹å‡»<code>Dump Java Heap</code>æŒ‰é’®ï¼Œç”Ÿæˆ Heap æ–‡ä»¶(*.hprof)</li>
</ol>

<p>é€šå¸¸è·å– Heap æ–‡ä»¶ä¹‹åä¼šç›´æ¥æ‰“å¼€ *.hprof æ–‡ä»¶ï¼Œä¸è¿‡æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ Android Studio å·¦ä¾§çš„<code>Captures</code>æ ‡ç­¾æ‰¾åˆ°å·²ç»ç”Ÿæˆçš„ Heap æ–‡ä»¶ã€‚</p>

<p><img src="http://o9xs75p7d.bkt.clouddn.com/2017-03-10-090110.jpg" alt="é€šè¿‡ Android Studio åˆ†æ Memory Leak" /></p>

<ol>
<li>æ‰“å¼€ Heap æ–‡ä»¶ä¹‹åï¼Œé¦–å…ˆæ‰“å¼€å³ä¾§çš„<code>Analyzer Tasks</code>æ ‡ç­¾</li>
<li>ç‚¹å‡»<code>perform action</code>æŒ‰é’®</li>
<li>åœ¨<code>Analysis Results</code>é‡Œå°±å¯ä»¥çœ‹åˆ°å…·ä½“æœ‰å“ªäº› Acitvity å¯¼è‡´äº†å†…å­˜æ³„æ¼</li>
<li>åœ¨<code>Reference Tree</code>é‡Œå¯ä»¥çœ‹åˆ°æŒæœ‰è¿™ä¸ª Activity å¼•ç”¨çš„å¯¹è±¡</li>
</ol>

<p>å¦‚æœæ˜¯ç®€å•çš„æƒ…å†µçš„è¯ï¼Œè¿™é‡Œå°±å¯ä»¥æ’æŸ¥å‡ºåˆ°åº•æ˜¯é‚£ä¸ªå¼•ç”¨å¯¼è‡´çš„ Activity æ— æ³•é‡Šæ”¾ï¼Œä»è€Œå¯¼è‡´äº†å†…å­˜æ³„æ¼ã€‚ä½†æ˜¯å¦‚æœæƒ…å†µå¤æ‚ä¸€äº›çš„è¯ï¼Œå°±éœ€è¦ç”¨åˆ° MAT æ¥åˆ†æäº†</p>

<h2 id="åˆ©ç”¨-mat-åˆ†æ-heap-æ–‡ä»¶">åˆ©ç”¨ MAT åˆ†æ Heap æ–‡ä»¶</h2>

<p>MAT å…¨ç§°&rdquo;Eclipse Memory Analyzer&rdquo;,æ˜¯ä¸€ä¸ªå¼ºå¤§ JAVA å †è½¬å‚¨æ–‡ä»¶åˆ†æå·¥å…·ï¼Œä¹Ÿå°±æ˜¯åˆ†æ *.hprof æ–‡ä»¶çš„å·¥å…·ã€‚</p>

<p><img src="http://o9xs75p7d.bkt.clouddn.com/2017-03-10-091145.jpg" alt="è½¬åŒ–ä¸ºæ ‡å‡†æ ¼å¼çš„æ–‡ä»¶" /></p>

<p>åœ¨ä½¿ç”¨ MAT ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå°† Android Studio ç”Ÿæˆçš„ Heap æ–‡ä»¶è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼ã€‚</p>

<p><img src="http://o9xs75p7d.bkt.clouddn.com/2017-03-10-092346.jpg" alt="ç­›é€‰å‡ºæ³„æ¼å¯¹è±¡" /></p>

<p>ç”¨ MAT æ‰“å¼€ Heap æ–‡ä»¶ä¹‹åç‚¹å‡»ç”Ÿæˆ Histogramï¼Œå¯ä»¥åˆ—å‡ºå†…å­˜ä¸­çš„å¯¹è±¡åŠå…¶ä¸ªæ•°ã€å¤§å°</p>

<p>ç”±äºæˆ‘ä»¬å·²ç»é€šè¿‡ Android Studioæˆ‘ä»¬å·²ç»çŸ¥é“æ³„æ¼çš„å¯¹è±¡çš„ç±»åã€‚æ‰€ä»¥å¯ä»¥ç›´æ¥ç­›é€‰å‡ºæ³„æ¼çš„å¯¹è±¡ã€‚å³é”®<code>Merge Shortest Paths to GC Roots</code> -&gt; <code>exclude all phantom/weak/soft etc. references</code>ã€‚æ’é™¤æ‰æ‰€æœ‰çš„è™š/è½¯/å¼±å¼•ç”¨ä¹‹åï¼Œå°±å¯ä»¥çŸ¥é“åˆ°åº•æ˜¯é‚£äº›å¯¹è±¡æŒæœ‰æ³„æ¼çš„ Activity çš„å¼ºå¼•ç”¨ä»è€Œå¯¼è‡´å†…å­˜æ³„æ¼äº†ã€‚</p>

<p><img src="http://o9xs75p7d.bkt.clouddn.com/2017-03-10-092955.jpg" alt="æŸ¥æ˜æ³„æ¼åŸå› " /></p>

<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯ Glide å¼•èµ·çš„ï¼Œæ­¤æ—¶å°±å¯ä»¥é€šè¿‡ä»£ç ä¸­ Glide ç›¸å…³çš„ä»£ç æ¥æ’æŸ¥ã€‚</p>

<blockquote>
<p>æ­¤å¤„çš„ä¾‹å­ï¼Œæ˜¯ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»<code>BitmapTransformation</code>æŒæœ‰äº† Activity çš„å¼•ç”¨ï¼Œè€Œ Glide æ˜¯å…¨å±€é…ç½®çš„ã€‚æ‰€ä»¥ Activity å¯¹è±¡æ— æ³•é‡Šæ”¾ï¼Œä»è€Œå¯¼è‡´äº†å†…å­˜æ³„æ¼</p>
</blockquote>

<h2 id="æ’æŸ¥ä»¥å¤–">æ’æŸ¥ä»¥å¤–</h2>

<p>å†…å­˜æ³„æ¼é€šå¸¸æ˜¯ç”±äºæˆ‘ä»¬ä»£ç çš„ä¸è§„èŒƒæ‰€å¯¼è‡´çš„ã€‚æ¯”å¦‚é•¿å¼•ç”¨æŒæœ‰å¯¹è±¡è€Œä¸é‡Šæ”¾å•Šï¼Œclosable å¯¹è±¡æœªåŠæ—¶å…³é—­å•Šï¼Œæˆ–è€…ä¸€äº›éé™æ€ç±»æŒæœ‰å¯¹è±¡å•Šã€‚</p>

<p>é™¤äº†åœ¨å†…å­˜æ³„æ¼å‘ç”Ÿä¹‹åï¼ŒåŠæ—¶çš„é€šè¿‡å·¥å…·æ¥æ’æŸ¥åŸå› ï¼Œä¿®æ”¹ä»£ç ä¹‹å¤–ï¼Œæœ€é‡è¦çš„è¿˜æ˜¯è¦è§„èŒƒè‡ªå·±çš„ä»£ç ï¼Œæé«˜ä»£ç è´¨é‡ã€‚å½“ç„¶ï¼Œä¸å¿½ç•¥ä»»ä½•ä¸€ä¸ª <code>lint</code> æç¤ºçš„è­¦å‘Šå¤§æ¦‚æ˜¯æœ€æ–¹ä¾¿å¿«æ·çš„æ–¹å¼äº†å§ï¼</p>

      </article>

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="https://diov.github.io/2017/02/27/%E4%BB%8E-hexo-%E5%88%B0-hugo/" data-toggle="tooltip" data-placement="top" title="ä» Hexo åˆ° Hugo">&larr; Previous Post</a>
        </li>
        
        
        <li class="next">
          <a href="https://diov.github.io/2017/09/16/%E5%9F%BA%E4%BA%8E-phabricator-%E7%9A%84-git-flow-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" data-toggle="tooltip" data-placement="top" title="åŸºäº Phabricator çš„ Git Flow æœ€ä½³å®è·µ">Next Post &rarr;</a>
        </li>
        
      </ul>

      
      <div class="disqus-comments">
        <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "diovgithubio" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
      

    </div>
  </div>
</div>

      

    </div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/diov" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
		      
          <li>
            <a href="mailto:diov87@outlook.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		      
	    	  
          
          

    		  <li>
      			<a href="https://diov.github.io/index.xml" title="RSS">
      			  <span class="fa-stack fa-lg">
        				<i class="fa fa-circle fa-stack-2x"></i>
        				<i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      			  </span>
      			</a>
    		  </li>		

        </ul>
        <p class="credits copyright text-muted">
    	  Dio_V
    	  &nbsp;&bull;&nbsp;
    	  2017
    		  
    	  
    	  &nbsp;&bull;&nbsp;
    	  <a href="https://diov.github.io/">Meow</a>
    	  
  	    </p>
  	    
    	<p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.27.1</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a> adapted to <a href="https://github.com/1138-4EB/beautifulhugo">Beautiful Hugo</a>
          
    	</p>
      </div>
    </div>
  </div>
</footer>

<script src="https://diov.github.io//js/jquery-1.11.2.min.js"></script>
<script src="https://diov.github.io//js/bootstrap.min.js"></script>
<script src="https://diov.github.io//js/main.js"></script>
<script src="https://diov.github.io/js/highlight.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>




  </body>
</html>
